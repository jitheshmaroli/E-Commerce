<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ORDERS LIST</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="/css/adminOrdersList.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="/images/test.jpg" alt="" width="30" height="24" class="d-inline-block align-text-top">
        SportZilon
      </a>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              ADMIN
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              <li><a class="dropdown-item" href="#">Action</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item" href="/admin/logout">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav> 
  <main class="main">
    <aside class="sidebar">
      <div class="">
        <div class="list-group sidebar-list" id="myListGroup">
          <a href="/admin">
            <button type="button" class="list-group-item list-group-item-action">HOME</button>
          </a>
          <a href="/admin/allproducts">
            <button type="button" class="list-group-item list-group-item-action">ALL PRODUCTS</button>
          </a>
          <a href="/admin/ordersList">
            <button type="button" class="list-group-item list-group-item-action ">ORDERS LIST</button>
          </a>
          <a href="/admin/usersList">
            <button type="button" class="list-group-item list-group-item-action">USERS LIST</button>
          </a>
          <a href="/admin/categoryList">
            <button type="button" class="list-group-item list-group-item-action">CATEGORY LIST</button>
          </a>
          <a href="/admin/couponList">
            <button type="button" class="list-group-item list-group-item-action">COUPON LIST</button>
          </a>
        </div>
      </div>
    </aside>
    <section class="content">
      <% if (orders.length <= 0) { %>
        <h4 style="text-align: center;">NO ORDERS AVAILABLE</h4>
       <% }else { %>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item active" aria-current="page">ALL ORDERS</li>
        </ol>
      </nav>
      <div class="container">   
        <table class="table" id="myTable">
          <thead>
            <tr>
              <th scope="col">ORDER ID</th>
              <th scope="col">ITEM NAME</th>
              <th scope="col">USER NAME</th>
              <th scope="col">ORDER DATE</th>
              <th scope="col">ACTION</th>              
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(order => { %>
              <tr>
                <td><%= order._id %></td>
                <td><%= order.items.map(item => item.name).join(', ') %></td>
                <td><%= order.userId.name %></td>
                <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                <td>
                  <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#orderDetails<%= order._id %>">Details</button>
                </td>
              </tr>
              <tr>
                <td colspan="6" class="hiddenRow">
                  <div class="collapse" id="orderDetails<%= order._id %>">
                    <div class="card">
                      <div class="card-body">
                        <h5 class="card-title">Order Details</h5>
                        <table class="table table-bordered" id="myTable">
                          <thead>
                            <tr>
                              <th>Product</th>
                              <th>Quantity</th>
                              <th>Price</th>
                              <th>Status</th>
                              <th>Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% order.items.forEach(item => { %>
                              <tr>
                                <td><%= item.name %></td>
                                <td><%= item.quantity %></td>
                                <td>$<%= item.price %></td>
                                <td><%= item.status %></td>
                                <td>
                                  <% if (item.status === "Pending") { %>
                                    <form onsubmit="updateOrderStatus(event, '<%= order._id %>', '<%= item.productId %>', 'Cancelled'); return false;" style="display: inline;">
                                      <button class="btn btn-danger" type="submit">Cancel</button>
                                    </form>
                                    <form onsubmit="updateOrderStatus(event, '<%= order._id %>', '<%= item.productId %>', 'Shipped'); return false;" style="display: inline;">
                                      <button class="btn btn-primary" type="submit">Ship</button>
                                    </form>
                                  <% }else if(item.status === "Cancelled" ){%>
                                    <form onsubmit="updateOrderStatus(event, '<%= order._id %>', '<%= item.productId %>', 'Shipped'); return false;" style="display: inline;">
                                      <button class="btn btn-primary" type="submit">Ship</button>
                                    </form>
                                  <% }else if(item.status === "Shipped" ){%> 
                                    <form onsubmit="updateOrderStatus(event, '<%= order._id %>', '<%= item.productId %>', 'Shipped'); return false;" style="display: inline;">
                                      <button class="btn btn-danger" type="submit">Cancel</button>
                                    </form>
                                    <form onsubmit="updateOrderStatus(event, '<%= order._id %>', '<%= item.productId %>', 'Delivered'); return false;" style="display: inline;">
                                      <button class="btn btn-success" type="submit">Delivered</button>
                                    </form>
                                  <% }else if(item.status === "Delivered" ){%>                                 
                                  <p>DELIVERED</p>
                                  <% } %>
                                </td>
                              </tr>
                            <% }); %>
                          </tbody>
                        </table>
                        <p>Total Amount: $<%= order.totalCost %></p>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      <% } %>
    </section>     
  </main> 
  <footer class="footer">
    <div class="container">
      <p class="copyright">Â© 2024 ShoesZone.</p>
    </div>
  </footer>   

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>

  <script>
    $(document).ready(function() {
      $('#myTable').DataTable();
    });
  </script>
  

  <script>
    document.querySelectorAll('[data-toggle="collapse"]').forEach(function(button) {
      button.addEventListener('click', toggleCollapse);
    });
    let openCollapse = null;

function toggleCollapse(event) {
  const currentCollapse = event.target.getAttribute('data-target');

  if (openCollapse && openCollapse !== currentCollapse) {
    const openCollapseElement = document.querySelector(openCollapse);
    const bsCollapse = new bootstrap.Collapse(openCollapseElement, { toggle: false });
    bsCollapse.hide();
  }

  openCollapse = currentCollapse;
}

async function updateOrderStatus(event, orderId, productId, status) {
  event.preventDefault();

  try {
    const response = await fetch(`/admin/updateOrderStatus/${orderId}/${productId}?status=${status}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      // Update the UI with the new status and buttons
      const statusElement = event.target.parentNode.parentNode.querySelector('td:nth-child(4)');
      const actionElement = event.target.parentNode.parentNode.querySelector('td:nth-child(5)');

      statusElement.textContent = status;
      actionElement.innerHTML = getActionButtons(status, orderId, productId);
    } else {
      console.error('Failed to update order status');
    }
  } catch (error) {
    console.error('Error:', error);
  }
}

function getActionButtons(status, orderId, productId) {
  let buttons = '';

  if (status === "Pending") {
    buttons += `
      <form onsubmit="updateOrderStatus(event, '${orderId}', '${productId}', 'Cancelled'); return false;" style="display: inline;">
        <button class="btn btn-danger" type="submit">Cancel</button>
      </form>
      <form onsubmit="updateOrderStatus(event, '${orderId}', '${productId}', 'Shipped'); return false;" style="display: inline;">
        <button class="btn btn-primary" type="submit">Ship</button>
      </form>
    `;
  } else if (status === "Cancelled") {
    buttons += `
      <form onsubmit="updateOrderStatus(event, '${orderId}', '${productId}', 'Shipped'); return false;" style="display: inline;">
        <button class="btn btn-primary" type="submit">Ship</button>
      </form>
    `;
  } else if (status === "Shipped") {
    buttons += `
      <form onsubmit="updateOrderStatus(event, '${orderId}', '${productId}', 'Cancelled'); return false;" style="display: inline;">
        <button class="btn btn-danger" type="submit">Cancel</button>
      </form>
      <form onsubmit="updateOrderStatus(event, '${orderId}', '${productId}', 'Delivered'); return false;" style="display: inline;">
        <button class="btn btn-success" type="submit">Delivered</button>
      </form>
    `;
  } else if (status === "Delivered") {
    buttons += '<p>DELIVERED</p>';
  }

  return buttons;
}
  </script>
</body>
</html>
